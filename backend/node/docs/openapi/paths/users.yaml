paths:
  /api/users/me:
    get:
      operationId: getUserProfile
      tags:
        - Users
      summary: Obtener perfil del usuario actual
      description: |
        Devuelve la información completa del perfil del usuario autenticado.
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Perfil del usuario
          content:
            application/json:
              schema:
                $ref: '../components/schemas/users.yaml#/components/schemas/UserProfileResponse'
        '401':
          $ref: '../components/responses.yaml#/components/responses/Unauthorized'
        '404':
          $ref: '../components/responses.yaml#/components/responses/NotFound'
    put:
      operationId: updateUserProfile
      tags:
        - Users
      summary: Actualizar perfil del usuario actual
      description: |
        Actualiza los datos del perfil del usuario autenticado. Solo se actualizan los campos proporcionados en el request body.
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '../components/schemas/users.yaml#/components/schemas/UpdateUserProfileRequest'
      responses:
        '200':
          description: Perfil actualizado exitosamente
          content:
            application/json:
              schema:
                $ref: '../components/schemas/users.yaml#/components/schemas/UserProfileResponse'
        '400':
          $ref: '../components/responses.yaml#/components/responses/BadRequest'
        '401':
          $ref: '../components/responses.yaml#/components/responses/Unauthorized'
        '404':
          $ref: '../components/responses.yaml#/components/responses/NotFound'
    delete:
      operationId: requestAccountDeletion
      tags:
        - Users
      summary: Solicitar eliminación de cuenta
      description: |
        Inicia el proceso de eliminación de cuenta con período de gracia. La cuenta no se eliminará inmediatamente sino después del período configurado.
      security:
        - BearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RequestAccountDeletionRequest'
      responses:
        '200':
          description: Solicitud de eliminación registrada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AccountDeletionResponse'
        '400':
          $ref: '../components/responses.yaml#/components/responses/BadRequest'
        '401':
          $ref: '../components/responses.yaml#/components/responses/Unauthorized'
  /api/users/me/email:
    put:
      operationId: updateUserEmail
      tags:
        - Users
      summary: Actualizar email del usuario
      description: |
        Actualiza el email del usuario autenticado. Requiere verificación posterior.
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateEmailRequest'
      responses:
        '200':
          description: Email actualizado exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EmailUpdateResponse'
        '400':
          description: Email inválido o ya en uso
          content:
            application/json:
              schema:
                $ref: '../components/common.yaml#/components/schemas/Error'
        '401':
          $ref: '../components/responses.yaml#/components/responses/Unauthorized'
  /api/users/me/deletion-request:
    get:
      operationId: getAccountDeletionStatus
      tags:
        - Users
      summary: Obtener estado de solicitud de eliminación
      description: |
        Consulta el estado de una solicitud de eliminación de cuenta pendiente.
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Estado de la solicitud
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AccountDeletionStatusResponse'
        '401':
          $ref: '../components/responses.yaml#/components/responses/Unauthorized'
    delete:
      operationId: cancelAccountDeletion
      tags:
        - Users
      summary: Cancelar solicitud de eliminación
      description: |
        Cancela una solicitud de eliminación de cuenta pendiente.
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Solicitud cancelada exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AccountDeletionResponse'
        '400':
          description: No hay solicitud pendiente
          content:
            application/json:
              schema:
                $ref: '../components/common.yaml#/components/schemas/Error'
        '401':
          $ref: '../components/responses.yaml#/components/responses/Unauthorized'
  /api/users/me/notification-settings:
    get:
      operationId: getNotificationSettings
      tags:
        - Users
      summary: Obtener configuración de notificaciones
      description: |
        Devuelve las preferencias de notificaciones del usuario autenticado.
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Configuración de notificaciones
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotificationSettingsResponse'
        '401':
          $ref: '../components/responses.yaml#/components/responses/Unauthorized'
    put:
      operationId: updateNotificationSettings
      tags:
        - Users
      summary: Actualizar configuración de notificaciones
      description: |
        Actualiza las preferencias de notificaciones del usuario autenticado.
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateNotificationSettingsRequest'
      responses:
        '200':
          description: Configuración actualizada exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotificationSettingsResponse'
        '400':
          $ref: '../components/responses.yaml#/components/responses/BadRequest'
        '401':
          $ref: '../components/responses.yaml#/components/responses/Unauthorized'
  /api/users/{userId}:
    get:
      operationId: getUserById
      tags:
        - Users
      summary: Obtener perfil de usuario por ID (admin)
      description: |
        Devuelve la información del perfil de un usuario específico. Solo para administradores.
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: userId
          required: true
          schema:
            type: integer
            minimum: 1
          description: ID del perfil de usuario
      responses:
        '200':
          description: Perfil del usuario
          content:
            application/json:
              schema:
                $ref: '../components/schemas/users.yaml#/components/schemas/UserProfileResponse'
        '401':
          $ref: '../components/responses.yaml#/components/responses/Unauthorized'
        '403':
          $ref: '../components/responses.yaml#/components/responses/Forbidden'
        '404':
          $ref: '../components/responses.yaml#/components/responses/NotFound'
  /api/users/{userId}/tokens:
    post:
      operationId: updateUserTokens
      tags:
        - Users
      summary: Actualizar tokens de un usuario (admin)
      description: |
        Incrementa o decrementa el balance de tokens de un usuario. Solo para administradores.
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: userId
          required: true
          schema:
            type: integer
            minimum: 1
          description: ID del perfil de usuario
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '../components/schemas/auth.yaml#/components/schemas/UpdateTokensRequest'
      responses:
        '200':
          description: Tokens actualizados exitosamente
          content:
            application/json:
              schema:
                $ref: '../components/schemas/auth.yaml#/components/schemas/TokensUpdateResponse'
        '400':
          $ref: '../components/responses.yaml#/components/responses/BadRequest'
        '401':
          $ref: '../components/responses.yaml#/components/responses/Unauthorized'
        '403':
          $ref: '../components/responses.yaml#/components/responses/Forbidden'
        '404':
          $ref: '../components/responses.yaml#/components/responses/NotFound'
  /api/users/me/tokens/balance:
    get:
      operationId: getMyTokenBalance
      tags:
        - Users
        - Tokens
      summary: Obtener balance de tokens del usuario autenticado
      description: |
        Obtiene el balance actual de tokens del usuario autenticado.
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Balance de tokens obtenido exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  id_user_profile:
                    type: integer
                    example: 1
                  balance:
                    type: integer
                    example: 150
        '401':
          $ref: '../components/responses.yaml#/components/responses/Unauthorized'
        '404':
          $ref: '../components/responses.yaml#/components/responses/NotFound'
  /api/users/me/tokens/ledger:
    get:
      operationId: getMyTokenLedger
      tags:
        - Users
        - Tokens
      summary: Obtener historial de movimientos de tokens del usuario autenticado
      description: |
        Obtiene el historial paginado de movimientos de tokens del usuario autenticado.
      security:
        - BearerAuth: []
      parameters:
        - in: query
          name: page
          schema:
            type: integer
            minimum: 1
            default: 1
          description: Número de página
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: Cantidad de resultados por página
        - in: query
          name: from_date
          schema:
            type: string
            format: date-time
          description: Filtrar desde esta fecha
        - in: query
          name: to_date
          schema:
            type: string
            format: date-time
          description: Filtrar hasta esta fecha
        - in: query
          name: ref_type
          schema:
            type: string
          description: Filtrar por tipo de referencia
        - in: query
          name: sortBy
          schema:
            type: string
            default: created_at
          description: Campo por el cual ordenar
        - in: query
          name: order
          schema:
            type: string
            enum: [asc, desc]
            default: desc
          description: Orden de los resultados
      responses:
        '200':
          description: Historial de tokens obtenido exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      type: object
                      properties:
                        id_ledger:
                          type: integer
                          example: 1
                        id_user_profile:
                          type: integer
                          example: 1
                        delta:
                          type: integer
                          example: 50
                        balance_after:
                          type: integer
                          example: 150
                        reason:
                          type: string
                          example: ACHIEVEMENT_UNLOCKED
                        ref_type:
                          type: string
                          nullable: true
                          example: achievement
                        ref_id:
                          type: integer
                          nullable: true
                          example: 5
                        metadata:
                          type: object
                          nullable: true
                        created_at:
                          type: string
                          format: date-time
                  page:
                    type: integer
                    example: 1
                  limit:
                    type: integer
                    example: 20
                  total:
                    type: integer
                    example: 45
                  totalPages:
                    type: integer
                    example: 3
        '401':
          $ref: '../components/responses.yaml#/components/responses/Unauthorized'
        '404':
          $ref: '../components/responses.yaml#/components/responses/NotFound'
  /api/users/me/tokens/stats:
    get:
      operationId: getMyTokenStats
      tags:
        - Users
        - Tokens
      summary: Obtener estadísticas de tokens del usuario autenticado
      description: |
        Obtiene estadísticas agregadas de tokens del usuario autenticado.
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Estadísticas de tokens obtenidas exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  balance:
                    type: integer
                    example: 150
                  total_earned:
                    type: integer
                    example: 500
                  total_spent:
                    type: integer
                    example: 350
                  earned_this_month:
                    type: integer
                    example: 100
                  spent_this_month:
                    type: integer
                    example: 50
        '401':
          $ref: '../components/responses.yaml#/components/responses/Unauthorized'
        '404':
          $ref: '../components/responses.yaml#/components/responses/NotFound'
  /api/users/{userId}/subscription:
    put:
      operationId: updateUserSubscription
      tags:
        - Users
      summary: Actualizar suscripción de un usuario (admin)
      description: |
        Cambia el nivel de suscripción de un usuario. Solo para administradores.
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: userId
          required: true
          schema:
            type: integer
            minimum: 1
          description: ID del perfil de usuario
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateSubscriptionRequest'
      responses:
        '200':
          description: Suscripción actualizada exitosamente
          content:
            application/json:
              schema:
                $ref: '../components/schemas/users.yaml#/components/schemas/UserProfileResponse'
        '400':
          $ref: '../components/responses.yaml#/components/responses/BadRequest'
        '401':
          $ref: '../components/responses.yaml#/components/responses/Unauthorized'
        '403':
          $ref: '../components/responses.yaml#/components/responses/Forbidden'
        '404':
          $ref: '../components/responses.yaml#/components/responses/NotFound'
components:
  schemas:
    RequestAccountDeletionRequest:
      type: object
      properties:
        reason:
          type: string
          description: Razón opcional de la eliminación
          example: "Ya no uso la aplicación"

    AccountDeletionResponse:
      type: object
      properties:
        message:
          type: string
          example: "Solicitud de eliminación registrada."
        request:
          type: object
          properties:
            id_request:
              type: integer
              example: 1
            id_account:
              type: integer
              example: 3
            reason:
              type: string
              nullable: true
            status:
              type: string
              enum: [PENDING, CANCELLED, COMPLETED]
            scheduled_deletion_date:
              type: string
              format: date
            requested_at:
              type: string
              format: date-time
            cancelled_at:
              type: string
              format: date-time
              nullable: true
            metadata:
              type: object
              nullable: true
            can_cancel:
              type: boolean

    AccountDeletionStatusResponse:
      type: object
      properties:
        request:
          type: object
          nullable: true
        has_active_request:
          type: boolean

    UpdateEmailRequest:
      type: object
      required:
        - email
      properties:
        email:
          type: string
          format: email

    EmailUpdateResponse:
      type: object
      properties:
        message:
          type: string
        email:
          type: string
          format: email

    UpdateSubscriptionRequest:
      type: object
      required:
        - subscription
      properties:
        subscription:
          type: string
          enum: [FREE, PREMIUM]
